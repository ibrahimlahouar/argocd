# =============================================================================
# ServiceMonitors pour les applications Data Platform
# =============================================================================
# Ces ServiceMonitors permettent à Prometheus de scraper les métriques
# des applications qui les exposent.
# =============================================================================

---
# Vault ServiceMonitor - Vault expose ses métriques sur /v1/sys/metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-metrics
  namespace: monitoring
  labels:
    app: vault
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - vault
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
  endpoints:
    - port: http
      path: /v1/sys/metrics
      params:
        format: ['prometheus']
      interval: 30s
      scheme: http

---
# MinIO ServiceMonitor - MinIO expose des métriques sur /minio/v2/metrics/cluster
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: minio-metrics
  namespace: monitoring
  labels:
    app: minio
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - minio
  selector:
    matchLabels:
      app: minio
      release: minio
  endpoints:
    - targetPort: 9000
      path: /minio/v2/metrics/cluster
      interval: 30s
      scheme: http

---
# ArgoCD Server ServiceMonitor - ArgoCD expose des métriques sur /metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: argocd-server-metrics
  namespace: monitoring
  labels:
    app: argocd
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - argocd
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-server
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scheme: http

---
# ArgoCD Repo Server ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: argocd-repo-server-metrics
  namespace: monitoring
  labels:
    app: argocd
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - argocd
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-repo-server
  endpoints:
    - port: metrics
      interval: 30s

---
# Ingress NGINX ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: ingress-nginx-metrics
  namespace: monitoring
  labels:
    app: ingress-nginx
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - ingress-nginx
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/component: controller
  endpoints:
    - port: metrics
      interval: 30s

---
# Harbor Exporter ServiceMonitor - Harbor expose des métriques via l'exporter
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: harbor-exporter-metrics
  namespace: monitoring
  labels:
    app: harbor
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - harbor
  selector:
    matchLabels:
      app: harbor
      component: exporter
  endpoints:
    - port: http-metrics
      interval: 30s
      path: /metrics

---
# Trino ServiceMonitor - Trino expose des métriques JMX
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: trino-metrics
  namespace: monitoring
  labels:
    app: trino
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - trino
  selector:
    matchLabels:
      app: trino
  endpoints:
    - targetPort: 8080
      path: /v1/info
      interval: 30s
      scheme: http

---
# Headlamp ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: headlamp-metrics
  namespace: monitoring
  labels:
    app: headlamp
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - headlamp
  selector:
    matchLabels:
      app.kubernetes.io/name: headlamp
  endpoints:
    - targetPort: 4466
      path: /metrics
      interval: 30s
      scheme: http

