# =============================================================================
# ServiceMonitors pour les applications Data Platform
# =============================================================================
# Ces ServiceMonitors permettent à Prometheus de scraper les métriques
# des applications qui les exposent correctement.
# 
# Note: Certains services (MinIO, ArgoCD, Headlamp) n'exposent pas de métriques
# par défaut ou sont bloqués par les Network Policies. Ces ServiceMonitors
# ont été désactivés pour éviter les faux positifs "TargetDown".
# =============================================================================

---
# Vault ServiceMonitor - Vault expose ses métriques sur /v1/sys/metrics
# Fonctionne car Vault expose nativement des métriques Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-metrics
  namespace: monitoring
  labels:
    app: vault
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - vault
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
  endpoints:
    - port: http
      path: /v1/sys/metrics
      params:
        format: ['prometheus']
      interval: 30s
      scheme: http

---
# Harbor Exporter ServiceMonitor
# Harbor a un exporter dédié pour les métriques
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: harbor-exporter-metrics
  namespace: monitoring
  labels:
    app: harbor
    release: monitoring
spec:
  namespaceSelector:
    matchNames:
      - harbor
  selector:
    matchLabels:
      app: harbor
      component: exporter
  endpoints:
    - port: http-metrics
      interval: 30s
      path: /metrics

# =============================================================================
# ServiceMonitors DÉSACTIVÉS (génèrent des faux positifs)
# =============================================================================
# Les services suivants ont été désactivés car:
# - MinIO: nécessite une configuration spéciale pour exposer /metrics
# - ArgoCD: les métriques sont sur un port séparé non exposé
# - Headlamp: n'expose pas de endpoint /metrics
# - Ingress-NGINX: bloqué par Network Policies
# - Trino: /v1/info n'est pas un endpoint Prometheus
#
# Pour les réactiver, il faudrait:
# 1. Configurer les apps pour exposer des métriques Prometheus
# 2. Mettre à jour les Network Policies pour autoriser le scraping
# =============================================================================
