# =============================================================================
# MONITORING STACK - Prometheus + Grafana + AlertManager
# =============================================================================
# Ce stack fournit une observabilitÃ© complÃ¨te de la Data Platform:
# - Prometheus: Collecte des mÃ©triques
# - Grafana: Dashboards et visualisation
# - AlertManager: Gestion des alertes
# =============================================================================

kube-prometheus-stack:
  # ---------------------------------------------------------------------------
  # GRAFANA
  # ---------------------------------------------------------------------------
  grafana:
    enabled: true
    
    # Admin credentials (changez en production!)
    adminUser: admin
    adminPassword: "DataPlatform2024!"
    
    # Persistence pour les dashboards
    persistence:
      enabled: true
      size: 5Gi
      storageClassName: local-path
    
    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - grafana.data-platform.local
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.data-platform.local
    
    # Datasources prÃ©-configurÃ©s (Loki + Tempo)
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki-stack.monitoring.svc:3100
        access: proxy
        isDefault: false
        jsonData:
          maxLines: 1000
      - name: Tempo
        type: tempo
        url: http://tempo.monitoring.svc:3100
        access: proxy
        isDefault: false
        jsonData:
          httpMethod: GET
          tracesToLogs:
            datasourceUid: loki
            tags: ['namespace', 'pod']
    
    # Plugins Grafana (dÃ©sactivÃ© - nÃ©cessite accÃ¨s Internet)
    # plugins:
    #   - grafana-piechart-panel
    #   - grafana-clock-panel
    
    # Dashboards par dÃ©faut
    defaultDashboardsEnabled: true
    defaultDashboardsTimezone: Europe/Paris
    
    # Service Monitor
    serviceMonitor:
      enabled: true

  # ---------------------------------------------------------------------------
  # PROMETHEUS
  # ---------------------------------------------------------------------------
  prometheus:
    enabled: true
    
    prometheusSpec:
      # Retention des donnÃ©es
      retention: 15d
      retentionSize: "10GB"
      
      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 20Gi
      
      # Ressources
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 1000m
      
      # Scrape tous les ServiceMonitors
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      
      # External labels
      externalLabels:
        cluster: data-platform
        environment: production
    
    # Ingress pour Prometheus UI
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - prometheus.data-platform.local
      tls:
        - secretName: prometheus-tls
          hosts:
            - prometheus.data-platform.local

  # ---------------------------------------------------------------------------
  # ALERTMANAGER
  # ---------------------------------------------------------------------------
  alertmanager:
    enabled: true
    
    alertmanagerSpec:
      # Storage
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
    
    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - alertmanager.data-platform.local
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.data-platform.local
    
    # Configuration des alertes avec Email
    config:
      global:
        resolve_timeout: 5m
        # Configuration SMTP pour Gmail
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: 'alertmanager@data-platform.local'
        smtp_auth_username: 'ibrahim.lahouar@gmail.com'
        # Gmail App Password (sans espaces)
        smtp_auth_password: 'nlllkwmzichvhbdq'
        smtp_require_tls: true
      
      route:
        group_by: ['alertname', 'namespace', 'severity']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        receiver: 'email-notifications'
        routes:
          # Alertes critiques - notification immÃ©diate
          - match:
              severity: critical
            receiver: 'email-critical'
            group_wait: 10s
            repeat_interval: 1h
          # Alertes warning
          - match:
              severity: warning
            receiver: 'email-notifications'
            repeat_interval: 6h
      
      receivers:
        - name: 'email-notifications'
          email_configs:
            - to: 'ibrahim.lahouar@gmail.com'
              send_resolved: true
              headers:
                Subject: '{{ template "email.default.subject" . }}'
              html: '{{ template "email.default.html" . }}'
        
        - name: 'email-critical'
          email_configs:
            - to: 'ibrahim.lahouar@gmail.com'
              send_resolved: true
              headers:
                Subject: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
      
      # Templates pour les emails
      templates:
        - '/etc/alertmanager/config/*.tmpl'

  # ---------------------------------------------------------------------------
  # NODE EXPORTER (mÃ©triques des nodes)
  # ---------------------------------------------------------------------------
  nodeExporter:
    enabled: true

  # ---------------------------------------------------------------------------
  # KUBE-STATE-METRICS (mÃ©triques Kubernetes)
  # ---------------------------------------------------------------------------
  kubeStateMetrics:
    enabled: true

  # ---------------------------------------------------------------------------
  # DÃ‰SACTIVER ALERTES FAUX POSITIFS
  # ---------------------------------------------------------------------------
  # Ces composants fonctionnent mais n'exposent pas de mÃ©triques dans Kubespray
  kubeProxy:
    enabled: false  # DÃ©sactive le ServiceMonitor pour kube-proxy
  
  kubeScheduler:
    enabled: false  # DÃ©sactive le ServiceMonitor pour kube-scheduler
  
  kubeControllerManager:
    enabled: false  # DÃ©sactive le ServiceMonitor pour kube-controller-manager
  
  # DÃ©sactiver les rÃ¨gles d'alerte pour ces composants
  defaultRules:
    rules:
      kubeProxy: false              # Pas de rÃ¨gles pour kube-proxy
      kubeSchedulerAlerting: false  # Pas d'alertes pour scheduler
      kubeSchedulerRecording: false # Pas de recording rules pour scheduler
      kubeControllerManager: false  # Pas de rÃ¨gles pour controller-manager

  # ---------------------------------------------------------------------------
  # PROMETHEUS OPERATOR
  # ---------------------------------------------------------------------------
  prometheusOperator:
    enabled: true
    
    # Webhook pour les CRDs
    admissionWebhooks:
      enabled: true
      patch:
        enabled: true

  # ---------------------------------------------------------------------------
  # RÃˆGLES D'ALERTE PERSONNALISÃ‰ES
  # ---------------------------------------------------------------------------
  additionalPrometheusRulesMap:
    data-platform-rules:
      groups:
        - name: data-platform
          rules:
            # Alerte si un pod crash
            - alert: PodCrashLooping
              expr: rate(kube_pod_container_status_restarts_total[15m]) > 0.1
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
                description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"
            
            # Alerte si un pod n'est pas ready
            - alert: PodNotReady
              expr: kube_pod_status_ready{condition="true"} == 0
              for: 10m
              labels:
                severity: warning
              annotations:
                summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            
            # Alerte si PVC presque plein
            - alert: PVCAlmostFull
              expr: kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "PVC {{ $labels.persistentvolumeclaim }} is almost full (>85%)"
            
            # Alerte si noeud down
            - alert: NodeNotReady
              expr: kube_node_status_condition{condition="Ready",status="true"} == 0
              for: 5m
              labels:
                severity: critical
              annotations:
                summary: "Node {{ $labels.node }} is not ready"

