# =============================================================================
# MONITORING STACK - Prometheus + Grafana + AlertManager
# =============================================================================
# Ce stack fournit une observabilité complète de la Data Platform:
# - Prometheus: Collecte des métriques
# - Grafana: Dashboards et visualisation
# - AlertManager: Gestion des alertes
# =============================================================================

kube-prometheus-stack:
  # ---------------------------------------------------------------------------
  # GRAFANA
  # ---------------------------------------------------------------------------
  grafana:
    enabled: true
    
    # Admin credentials (changez en production!)
    adminUser: admin
    adminPassword: "DataPlatform2024!"
    
    # Persistence pour les dashboards
    persistence:
      enabled: true
      size: 5Gi
      storageClassName: local-path
    
    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - grafana.data-platform.local
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.data-platform.local
    
    # Datasources pré-configurés
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.monitoring.svc:3100
        access: proxy
        isDefault: false
    
    # Plugins Grafana (désactivé - nécessite accès Internet)
    # plugins:
    #   - grafana-piechart-panel
    #   - grafana-clock-panel
    
    # Dashboards par défaut
    defaultDashboardsEnabled: true
    defaultDashboardsTimezone: Europe/Paris
    
    # Service Monitor
    serviceMonitor:
      enabled: true

  # ---------------------------------------------------------------------------
  # PROMETHEUS
  # ---------------------------------------------------------------------------
  prometheus:
    enabled: true
    
    prometheusSpec:
      # Retention des données
      retention: 15d
      retentionSize: "10GB"
      
      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 20Gi
      
      # Ressources
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 1000m
      
      # Scrape tous les ServiceMonitors
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      
      # External labels
      externalLabels:
        cluster: data-platform
        environment: production
    
    # Ingress pour Prometheus UI
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - prometheus.data-platform.local
      tls:
        - secretName: prometheus-tls
          hosts:
            - prometheus.data-platform.local

  # ---------------------------------------------------------------------------
  # ALERTMANAGER
  # ---------------------------------------------------------------------------
  alertmanager:
    enabled: true
    
    alertmanagerSpec:
      # Storage
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
    
    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: vault-issuer
      hosts:
        - alertmanager.data-platform.local
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.data-platform.local
    
    # Configuration des alertes (à personnaliser)
    config:
      global:
        resolve_timeout: 5m
      
      route:
        group_by: ['alertname', 'namespace']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        receiver: 'default-receiver'
        routes:
          - match:
              severity: critical
            receiver: 'critical-receiver'
      
      receivers:
        - name: 'default-receiver'
          # webhook_configs:
          #   - url: 'http://your-webhook-url'
        - name: 'critical-receiver'
          # pagerduty_configs:
          #   - service_key: 'your-pagerduty-key'

  # ---------------------------------------------------------------------------
  # NODE EXPORTER (métriques des nodes)
  # ---------------------------------------------------------------------------
  nodeExporter:
    enabled: true

  # ---------------------------------------------------------------------------
  # KUBE-STATE-METRICS (métriques Kubernetes)
  # ---------------------------------------------------------------------------
  kubeStateMetrics:
    enabled: true

  # ---------------------------------------------------------------------------
  # PROMETHEUS OPERATOR
  # ---------------------------------------------------------------------------
  prometheusOperator:
    enabled: true
    
    # Webhook pour les CRDs
    admissionWebhooks:
      enabled: true
      patch:
        enabled: true

  # ---------------------------------------------------------------------------
  # RÈGLES D'ALERTE PERSONNALISÉES
  # ---------------------------------------------------------------------------
  additionalPrometheusRulesMap:
    data-platform-rules:
      groups:
        - name: data-platform
          rules:
            # Alerte si un pod crash
            - alert: PodCrashLooping
              expr: rate(kube_pod_container_status_restarts_total[15m]) > 0.1
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
                description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"
            
            # Alerte si un pod n'est pas ready
            - alert: PodNotReady
              expr: kube_pod_status_ready{condition="true"} == 0
              for: 10m
              labels:
                severity: warning
              annotations:
                summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            
            # Alerte si PVC presque plein
            - alert: PVCAlmostFull
              expr: kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "PVC {{ $labels.persistentvolumeclaim }} is almost full (>85%)"
            
            # Alerte si noeud down
            - alert: NodeNotReady
              expr: kube_node_status_condition{condition="Ready",status="true"} == 0
              for: 5m
              labels:
                severity: critical
              annotations:
                summary: "Node {{ $labels.node }} is not ready"

