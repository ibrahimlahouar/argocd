# =============================================================================
# NETWORK POLICIES - Configuration Production
# =============================================================================
# Stratégie Zero Trust:
# 1. Default Deny: Bloquer tout trafic par défaut
# 2. Allow DNS: Autoriser la résolution DNS (critique)
# 3. Allow K8s API: Autoriser l'accès à l'API Kubernetes (pour les controllers)
# 4. Allow Ingress: Autoriser le trafic depuis l'Ingress Controller
# 5. Allow Internal: Autoriser la communication interne au namespace
# 6. Allow Specific: Autoriser les flux spécifiques entre services
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION CLUSTER (adapter à votre environnement)
# -----------------------------------------------------------------------------
cluster:
  # DNS Configuration - Kubespray utilise NodeLocalDNS
  dns:
    # NodeLocalDNS IP (utilisé par Kubespray)
    nodeLocalIP: "169.254.25.10"
    # CoreDNS Service IP (fallback)
    coreDNSIP: "10.233.0.3"
    # Namespace CoreDNS
    namespace: kube-system
    # Port DNS
    port: 53

  # Kubernetes API Configuration
  kubeAPI:
    # Service IP de l'API Kubernetes
    serviceIP: "10.233.0.1"
    # Port HTTPS
    port: 443
    # CIDR pour les masters (si besoin d'accès direct)
    mastersCIDR: "10.10.0.0/24"

  # Pod Network CIDR (pour communication interne)
  podCIDR: "10.233.64.0/18"
  
  # Service Network CIDR
  serviceCIDR: "10.233.0.0/18"

# -----------------------------------------------------------------------------
# NAMESPACES À PROTÉGER
# -----------------------------------------------------------------------------
# Ces namespaces auront des Network Policies appliquées
protectedNamespaces:
  # Infrastructure
  - name: ingress-nginx
    hasIngress: false  # C'est lui l'ingress
    needsKubeAPI: true
    
  - name: cert-manager
    hasIngress: false
    needsKubeAPI: true
    needsVault: true
    
  - name: metallb-system
    hasIngress: false
    needsKubeAPI: true

  # Infrastructure - Shared Database
  - name: infra
    hasIngress: false
    needsKubeAPI: false
    # C'est le namespace de postgres-shared

  # Services Core
  - name: harbor
    hasIngress: true
    ingressPort: 80
    needsExternal: true  # Trivy télécharge des DBs
    needsPostgreSQL: true  # External PostgreSQL
    
  - name: vault
    hasIngress: true
    ingressPort: 8200
    
  - name: minio
    hasIngress: true
    ingressPorts: [9000, 9001]
    
  - name: headlamp
    hasIngress: true
    ingressPort: 4466
    needsKubeAPI: true

  # Nessie - Iceberg Catalog
  - name: nessie
    hasIngress: false
    needsMinio: true
    needsPostgreSQL: true  # For metadata storage

  # Data Platform
  - name: trino
    hasIngress: true
    ingressPort: 8080
    needsMinio: true
    needsVault: true
    needsPostgreSQL: true  # For PostgreSQL connector
    needsNessie: true  # For Iceberg catalog
    
  - name: openmetadata
    hasIngress: true
    ingressPorts: [8585, 8080]
    needsMinio: true
    needsVault: true
    needsTrino: true
    needsKubeAPI: true  # Pour KubernetesExecutor Airflow
    needsExternal: true  # Pour télécharger packages PyPI
    needsPostgreSQL: true  # For database
    needsNessie: true  # For data lineage
    needsOpenSearch: true # For search index
    
  - name: airflow
    hasIngress: true
    ingressPort: 8080
    needsKubeAPI: true
    needsExternal: true  # GitSync + public API fetches in demo DAGs
    needsPostgreSQL: true  # For database
    needsMinio: true # For fetching/storing DAG data/scripts
    
  - name: spark
    hasIngress: false
    needsMinio: true
    needsVault: true
    needsKubeAPI: true
    needsOpenMetadata: true
    needsNessie: true  # For Iceberg tables
    needsExternal: true  # Download Maven packages for Iceberg/Nessie at runtime
    
  - name: spark-operator
    hasIngress: false
    needsKubeAPI: true
    needsOpenMetadata: true
    needsMinio: true
    needsExternal: true

  # Monitoring Stack
  - name: monitoring
    hasIngress: true
    ingressPorts: [3000, 9090, 9093]  # Grafana, Prometheus, AlertManager
    needsKubeAPI: true  # Pour scraper les métriques K8s
    needsExternal: true  # Grafana télécharge des plugins

  # Dashboard - Static HTML dashboard
  - name: dashboard
    hasIngress: true
    ingressPort: 80

  # Velero namespace (db-backups jobs need PostgreSQL + MinIO + DNS)
  - name: velero
    hasIngress: false
    needsMinio: true
    needsPostgreSQL: true

# -----------------------------------------------------------------------------
# CONFIGURATION INGRESS CONTROLLER
# -----------------------------------------------------------------------------
ingress:
  namespace: ingress-nginx
  podLabels:
    app.kubernetes.io/name: ingress-nginx

# -----------------------------------------------------------------------------
# SERVICES ENDPOINTS (pour les flux inter-services)
# -----------------------------------------------------------------------------
services:
  vault:
    namespace: vault
    port: 8200
    
  minio:
    namespace: minio
    port: 9000
    
  trino:
    namespace: trino
    port: 8080
    
  openmetadata:
    namespace: openmetadata
    port: 8585

  harbor:
    namespace: harbor
    ports: [80, 443, 5000]

  # PostgreSQL - Central database for all services
  postgresql:
    namespace: infra
    port: 5432
    serviceName: postgres-shared-postgresql

  # Nessie - Iceberg Catalog
  nessie:
    namespace: nessie
    port: 19120
    serviceName: nessie

  # OpenSearch - Search Engine
  opensearch:
    namespace: opensearch
    port: 9200
    serviceName: opensearch-cluster-master
