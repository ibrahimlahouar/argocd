airflow:
  airflow:
    image:
      repository: apache/airflow
      tag: 2.7.3-python3.10
      pullPolicy: IfNotPresent
    
    extraPipPackages:
      - "openmetadata-ingestion[airflow-container]==1.5.4"
    
    extraVolumes:
      - name: openmetadata-libs
        emptyDir: {}
    
    extraVolumeMounts:
      - name: openmetadata-libs
        mountPath: /opt/openmetadata-libs
    
    extraInitContainers:
      - name: install-managed-apis
        image: apache/airflow:2.7.3-python3.10
        command: ["bash", "-c", "PIP_USER=false pip install --target /opt/openmetadata-libs openmetadata-managed-apis==1.5.4 --no-deps Flask-Admin==1.6.0"]
        volumeMounts:
          - name: openmetadata-libs
            mountPath: /opt/openmetadata-libs
    
    extraEnv:
      - name: PYTHONPATH
        value: "/opt/openmetadata-libs"
        
    config:
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.session,airflow.api.auth.backend.basic_auth"
      AIRFLOW__OPENMETADATA_AIRFLOW_APIS__DAG_GENERATED_CONFIGS: "/opt/airflow/dags"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "True"

    users:
    - username: admin
      password: admin
      role: Admin
      email: admin@example.com
      firstName: Admin
      lastName: User

  web:
    service:
      type: NodePort
      ports:
        - name: airflow-ui
          port: 8080
          nodePort: 32080

  externalDatabase:
    type: postgres
    host: postgres-shared-postgresql.infra.svc.cluster.local
    port: 5432
    database: airflow_db
    user: airflow_user
    passwordSecret: postgres-shared-secrets
    passwordSecretKey: airflow-password

  serviceAccount:
    create: true
    name: "airflow"

  dags:
    persistence:
      enabled: true
      size: 1Gi
      accessMode: ReadWriteOnce
  
  logs:
    persistence:
      enabled: true
      size: 1Gi
      accessMode: ReadWriteOnce

  scheduler:
    logCleanup:
      enabled: false

  workers:
    logCleanup:
      enabled: false

  # Enable migration job explicitly
  migrateDatabaseJob:
    enabled: true
    jobAnnotations:
      "argocd.argoproj.io/hook": "PreSync"
      "argocd.argoproj.io/hook-delete-policy": "BeforeHookCreation"
